{% extends "editorial/base.html" %}

{% load a4a %}
{% load static %}

{% block page_title %}Accueil{% endblock%}

{% block editorial_content %}
  <div class="mb-4">
    {% if empty_query %}
    <div class="alert alert-info">Merci de préciser votre recherche.</div>
    {% endif %}
    <form action="{% url "home" %}">
      <div class="d-flex justify-content-between align-items-center">
        <input type="search" name="q" class="form-control form-control-lg" placeholder="Rechercher un établissement, une ville, une activité"
          aria-label="Rechercher un établissement, une ville, une activité" autocomplete="off" value="{{ search|default_if_none:"" }}" required>
        <button type="submit" class="btn btn-primary btn-lg ml-2 d-none d-md-inline-block">Rechercher</button>
      </div>
      <div class="custom-control custom-switch ml-3 mt-2">
        <input type="checkbox" class="custom-control-input" name="access" id="access" value="1"
          {% if request.GET.access == "1" %}checked{% endif %}>
        <label class="custom-control-label" for="access">
          N'afficher que les établissements dont les données d'accessibilité sont disponibles
        </label>
      </div>
      <div class="custom-control custom-switch ml-3 mt-2">
        <input type="checkbox" class="custom-control-input" name="localize" id="localize" value="1"
          {% if request.GET.localize == "1" %}checked{% endif %}>
        <label class="custom-control-label" for="localize">
          Rechercher autour de ma position géographique actuelle <strong id="loc" aria-label="Mon emplacement"></strong>
        </label>
      </div>
      <input type="hidden" name="lat">
      <input type="hidden" name="lon">
      <script>
      (function() {
        function listenToLocCheckboxChange() {
          return function(event) {
            processLocCheckbox(event.target);
          }
        }
        function processLocCheckbox(node) {
          if (!node.checked) {
            document.querySelector("#loc").innerText = "";
            document.querySelector("input[name=lat]").value = null;
            document.querySelector("input[name=lon]").value = null;
          } else {
            navigator.geolocation.getCurrentPosition(function(position) {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              fetch("https://api-adresse.data.gouv.fr/reverse/?lon=" + lon + "&lat=" + lat + "&type=street")
                .then(function(response) {
                  return response.json()
                })
                .then(function(json) {
                  let label;
                  try {
                    label = "(" + json.features[0].properties.label + ")"
                  } catch (e) {
                    label = "(" + lat + ", " + lon + ")";
                  }
                  const loc = document.querySelector("#loc");
                  loc.innerText = label;
                  loc.setAttribute("role", "status");
                  document.querySelector("input[name=lat]").value = lat;
                  document.querySelector("input[name=lon]").value = lon;
                })
                .catch(function(err) {
                  console.warn("Le service de géopositionnement inverse a retourné une erreur : " + err);
                });
            }, function(err) {
              alert("Nous n'avons pas pu déterminer votre position géographique.")
            });
          }
        }
        window.addEventListener("DOMContentLoaded", function() {
          const locCheckbox = document.querySelector("#localize");
          locCheckbox.addEventListener("change", listenToLocCheckboxChange());
          setTimeout(function() {
            // Note: a timeout is required in order to reprocess the form state after navigating back
            processLocCheckbox(locCheckbox);
          }, 10);
        });
      })();
      </script>
    </form>
  </div>
  <div class="row">
    <div class="col-sm-8">
      {% if search_results %}
      {% if request.GET.localize != "1" %}
        {% if search_results.communes %}
        <h3 class="mb-3">Villes</h3>
        {% endif %}
        <div class="row row-cols-1 row-cols-md-2">
          {% for commune in search_results.communes %}
          <div class="col mb-4">
            <div class="card shadow-sm">
              <div class="card-body p-3 d-flex justify-content-between align-items-center">
                <div>
                  <small class="text-muted">{{ commune.departement_nom }}</small>
                  <h5 class="card-title mb-0">
                    <a href="{% url 'commune' commune.slug %}">{{ commune.nom }}</a>
                  </h5>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% endif %}
      <section>
        <h3 class="mb-3">Établissements {% if request.GET.localize == "1" %}proches de moi{% endif %}</h3>
        <div class="row row-cols-1 row-cols-md-2">
          {% for erp in search_results.erps %}
          <div class="col mb-4">
            <div class="card shadow-sm mb-2">
              <div class="card-body p-3">
                {% if erp.has_accessibilite %}
                <i class="icon icon-checklist text-success" title="accessibilité renseignée"></i>
                <span class="sr-only">accessibilité renseignée</span>
                {% endif %}
                <a href="{{ erp.get_absolute_url }}">{{ erp.nom }}</a>
                {% if request.GET.localize == "1" %}
                  <small class="text-muted" aria-label="Distance de votre position géographique">
                    <em>(à {{ erp.distance|format_distance }})</em>
                  </small>
                {% endif %}
                <br>
                {# <small>rank: {{ erp.rank }}, sim: {{ erp.similarity }}, dist: {{ erp.distance_nom }}</small><br> #}
                {% if erp.activite %}<small>{{ erp.activite }}</small>{% endif %}
                <address class="mb-0">
                  <em>
                    <small class="text-muted">
                      {{ erp.short_adresse }} {{ erp.code_postal }}
                      <a href="{% url "commune" commune=erp.commune_ext.slug%}">{{ erp.commune_ext.nom }}</a>
                    </small>
                  </em>
                </address>
              </div>
            </div>
          </div>
          {% empty %}
          <p class="col">Aucun résultat.</p>
          {% endfor %}
        </div>
      </section>
      {% else %}
      <div class="row row-cols-1 row-cols-md-2" id="home-communes-list">
        {% for commune in communes %}
        <div class="col mb-4">
          <div class="card shadow-sm">
            <a href="{% url 'commune' commune.slug %}" tabindex="-1">
              <img class="card-img-top" alt="{{ commune.nom }}"
                src="https://api.mapbox.com/styles/v1/mapbox/light-v10/static/{{ commune.geom.coords.0 }},{{ commune.geom.coords.1 }},11,0,50/348x139@2x?access_token=pk.eyJ1IjoibjFrMCIsImEiOiJjazdkOTVncDMweHc2M2xyd2Nhd3BueTJ5In0.-Mbvg6EfocL5NqjFbzlOSw" alt="">
            </a>
            <div class="card-body p-3 d-flex justify-content-between align-items-center">
              <div>
                <small class="text-muted">{{ commune.departement_nom }}</small>
                <h5 class="card-title mb-0">
                  <a href="{% url 'commune' commune.slug %}">{{ commune.nom }}</a>
                </h5>
              </div>
              <a class="btn btn-sm btn-primary px-1 py-0" href="{% url 'commune' commune.slug %}"
                title="{{ commune.erp_access_count }} établissement{{ commune.erp_access_count|pluralize:"s" }} dont l'accessibilité est renseignée sur {{ commune.erp_count }}">
                <strong>{{ commune.erp_access_count }}</strong><small>/{{ commune.erp_count }}</small>
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    <div class="col-sm-4">
      <a href="{% url "contrib_start" %}" class="btn btn-primary btn-block mb-3">Ajouter mon établissement</a>
      <div class="card">
        <div class="card-header"><h6 class="m-0">Derniers établissements renseignés</h6></div>
        {# FIXME: list-group class should be needed here but adds a 2px top border on first element #}
        <div class="list-group-flush" id="home-latest-erps-list">
          {% for erp in latest %}
          <a href="{{ erp.get_absolute_url }}" class="list-group-item list-group-item-action">
            {{ erp.commune }} {% if erp.activite %}&raquo; <span class="text-muted">{{ erp.activite.nom}}</span>{% endif %}
            <br><strong>{{ erp.nom }}</strong>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
