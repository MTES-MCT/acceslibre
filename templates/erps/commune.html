{% extends "base.html" %}

{% load static %}

{% block page_title %}{% if erp %}{{ erp.nom }} | {% endif %}{% if current_activite %}{{ current_activite.nom }} | {% endif %}{{ commune.nom }}{% endblock%}

{% block page_description %}{% spaceless %}
  {% if erp %}
    Découvrez l'accessibilité de l'établissement {{ erp.nom }} à {{ commune.nom }} - {{ commune.departement_nom}}
  {% else %}
    Découvrez l'accessibilité des établissements recevant du public de la ville de {{ commune.nom }}
  {% endif %}
{% endspaceless %}{% endblock %}

{% block content %}
  <nav class="navbar navbar-expand-lg navbar-dark a4a-navbar">
    <h1 class="h3"><a class="navbar-brand" href="{% url "home" %}">{{ SITE_NAME }}</a></h1>
    <button class="navbar-toggler" type="button" data-toggle="collapse"
        data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="{% url "home" %}">Accueil</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url "contact_form" %}">Contact</a>
        </li>
      </ul>
      <form class="form-inline my-2 my-lg-0 ml-1 flex-fill" action="{% url "commune" commune=commune.slug %}" method="get">
        <input class="form-control mr-sm-2 w-100" name="q" id="q" type="search"
            data-commune="{{ commune.nom }}"
            data-commune-slug="{{ commune.slug }}"
            data-lat="{{ commune.center.1 }}"
            data-lon="{{ commune.center.0 }}"
            placeholder="Rue, restaurant, café, poste, pharmacie... à {{ commune.nom }}"
            value="{{ search_terms|default_if_none:"" }}" aria-label="Rechercher" autocomplete="off">
      </form>
      <ul class="navbar-nav mr-auto">
        <li>
          <a class="nav-link" href="{% url "contrib_start" %}">Ajouter un établissement</a>
        </li>
      {% if user.is_authenticated %}
        <li class="nav-item">
          <a class="nav-link" href="{% url "mon_compte" %}">Mon compte</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url "logout" %}?next={{ request.path }}">Déconnexion</a>
        </li>
      {% else %}
        <li class="nav-item">
          <a class="nav-link" href="{% url "login" %}?next={{ request.path }}">Connexion</a>
        </li>
      {% endif %}
      </ul>
    </div>
  </nav>

  <div class="container-fluid p-0 m-0 a4a-app-content">
    <aside class="a4a-app-title row p-0 m-0">
      <div class="col pt-2 pb-1">
        <div class="display-4 a4a-large-breadcrumb">
          <a href="{% url "commune" commune.slug %}">{{ commune.nom }}</a>
          {% if current_activite %}
          <small class="text-muted">
            &raquo; <a href="{% url 'commune_activite' commune=commune.slug activite_slug=current_activite.slug %}">{{ current_activite.nom }}</a>
          </small>
          {% endif %}
          {% if search_terms %}
          <small class="text-muted">&raquo; Recherche de <em>{{ search_terms }}</em></small>
          {% endif %}
        </div>
      </div>
    </aside>

    <div class="row p-0 m-0">
      {% if erp %}
      <main id="content" class="a4a-app-main col-lg-6 col-md-8 col-sm-12 erp-list p-0 m-0 border-top overflow-auto">
        <div class="px-3">
          <p class="row py-2 a4a-backlink">
            <a href="javascript:history.go(-1)">
                &laquo; Retour à la page précédente
            </a>
          </p>
          {% include "erps/commune/erp.html" with erp=erp %}
        </div>
      </main>
      <div class="a4a-app-map col-lg-6 col-md-4 d-none d-md-block map-area p-0 m-0">
        {% include "common/map.html" %}
      </div>

      {% else %}

      <main id="content" class="a4a-app-main col-lg-5 col-md-5 col-sm-8 erp-list p-0 m-0 border-top overflow-auto">
        <h2 class="sr-only">Liste des établissements à {{ commune.nom }}</h2>
        <div class="list-group list-group-flush">
          {% if object_list %}
          {% for erp in object_list %}
          <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center a4a-erp-list-item"
              href="{{ erp.get_absolute_url }}">
            <span class="flex-fill">
              <h3 class="h6 m-0">{{ erp.nom }}</h3>
              <small class="text-muted">
                {% if erp.activite %}<strong>{{ erp.activite.nom }}</strong> &raquo; {% endif %}
                {{ erp.numero|default_if_none:"" }}
                {{ erp.voie|default_if_none:"" }}
                {{ erp.lieu_dit|default_if_none:"" }}
              </small>
            </span>
            {% if erp.accessibilite %}
            <button class="btn btn-sm btn-outline-success mr-2 a4a-icon-btn" title="Les informations d'accessibilités sont disponibles">
              <i aria-hidden="true" class="icon icon-checklist"></i>
              <span class="sr-only">Les informations d'accessibilités sont disponibles</span>
            </button>
            {% endif %}
            <button class="btn btn-sm btn-outline-primary d-none d-sm-none d-md-block a4a-icon-btn a4a-geo-link"
                title="Localiser sur la carte" data-erp-id="{{ erp.pk }}">
              <i aria-hidden="true" class="icon icon-target"></i>
            </button>
          </a>
          {% endfor %}
          {% elif search_terms %}
          <p class="p-2 m-2">Votre recherche pour <q>{{ search_terms }}</q> n'a retourné aucun résultat.</p>
          {% else %}
          <p class="p-2 m-2">Aucun établissement correspondant.</p>
          {% endif %}
        </div>
      </main>
      <nav class="a4a-app-nav col-lg-2 col-md-3 col-sm-4 order-first d-none d-sm-block bg-light activites-list p-0 m-0 border-top overflow-auto">
        <h2 class="sr-only">Domaines d'activité à {{ commune.nom }}</h2>
        <div class="list-group list-group-flush border-right">
          {% for activite in activites %}
          <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center{% if current_activite and current_activite.pk == activite.pk %} active{% endif %}"
              href="{% url 'commune_activite' commune=commune.slug activite_slug=activite.slug %}">
            {{ activite.nom }}
            <span class="badge badge-primary badge-pill">{{ activite.count }}</span>
          </a>
          {% endfor %}
          <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center{% if current_activite and current_activite.pk == activite.pk %} active{% endif %}"
              href="{% url 'commune_activite' commune=commune.slug activite_slug="non-categorises" %}">
            Activité indéterminée
          </a>
        </div>
      </nav>
      <div class="a4a-app-map col-lg-5 col-md-4 order-last d-none d-md-block map-area p-0 m-0">
        {% include "common/map.html" %}
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    initAppMap({{ commune_json | safe }}, {% if erp %}{{ erp.pk }}{% else %}null{% endif %}, {{ around|default_if_none:"null" }}, {{ geojson_list | safe }});
  </script>
{% endblock %}
