{% load crispy_forms_tags %}

<form action="{% url "contrib_start" %}" method="post" class="card mb-4">
  <div class="card-header">
    <h3 class="h6 mb-0">Je recherche <strong>un établissement administratif</strong></h3>
  </div>
  <div class="card-body">
    {% csrf_token %}
    {% if public_erp_error %}
      <div class="alert alert-danger">{{ public_erp_error }}</div>
    {% endif %}
    {{ public_erp_form|crispy }}
    <button type="submit" name="search_type" value="by-public-erp" class="btn btn-primary w-100">
      <i aria-hidden="true" class="icon icon-magnifying-glass"></i>
      Rechercher un établissement public
    </button>
  </div>
  <script>
  function addArrondissements(results) {
    // Yes, it's 2020 already and here we are.
    const lyonArrondissements = [
      { code: 69381, nom: "Lyon 1er arr.", d_code: 69, d_nom: "Rhône" },
      { code: 69383, nom: "Lyon 3ème arr.", d_code: 69, d_nom: "Rhône" },
      { code: 69382, nom: "Lyon 2ème arr.", d_code: 69, d_nom: "Rhône" },
      { code: 69384, nom: "Lyon 4ème arr.", d_code: 69, d_nom: "Rhône" },
      { code: 69385, nom: "Lyon 5ème arr.", d_code: 69, d_nom: "Rhône" },
      { code: 69386, nom: "Lyon 6ème arr.", d_code: 69, d_nom: "Rhône" },
      { code: 69387, nom: "Lyon 7ème arr.", d_code: 69, d_nom: "Rhône" },
      { code: 69388, nom: "Lyon 8ème arr.", d_code: 69, d_nom: "Rhône" },
      { code: 69389, nom: "Lyon 9ème arr.", d_code: 69, d_nom: "Rhône" }
    ];
    const marseilleArrondissements = [
      { code: 13201, nom: "Marseille 1ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13202, nom: "Marseille 2ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13203, nom: "Marseille 3ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13204, nom: "Marseille 4ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13205, nom: "Marseille 5ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13206, nom: "Marseille 6ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13207, nom: "Marseille 7ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13208, nom: "Marseille 8ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13209, nom: "Marseille 9ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13210, nom: "Marseille 10ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13211, nom: "Marseille 11ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13212, nom: "Marseille 12ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13213, nom: "Marseille 13ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13214, nom: "Marseille 14ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13215, nom: "Marseille 15ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" },
      { code: 13216, nom: "Marseille 16ème arr.", d_code: 13, d_nom: "Bouches-du-Rhône" }
    ];
    const parisArrondissements = [
      { code: 75101, nom: "Paris 1er arr.", d_code: 75, d_nom: "Paris" },
      { code: 75102, nom: "Paris 2eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75103, nom: "Paris 3eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75104, nom: "Paris 4eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75105, nom: "Paris 5eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75106, nom: "Paris 6eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75107, nom: "Paris 7eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75108, nom: "Paris 8eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75109, nom: "Paris 9eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75110, nom: "Paris 10eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75111, nom: "Paris 11eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75112, nom: "Paris 12eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75113, nom: "Paris 13eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75114, nom: "Paris 14eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75115, nom: "Paris 15eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75116, nom: "Paris 16eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75117, nom: "Paris 17eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75118, nom: "Paris 18eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75119, nom: "Paris 19eme arr.", d_code: 75, d_nom: "Paris" },
      { code: 75120, nom: "Paris 20eme arr.", d_code: 75, d_nom: "Paris" }
    ];
    let arrondissements = [];
    if (results.some(function(r) { return r.nom === "Lyon" })) {
      arrondissements = lyonArrondissements;
    } else if (results.some(function(r) { return r.nom === "Marseille" })) {
      arrondissements = marseilleArrondissements;
    } else if (results.some(function(r) { return r.nom === "Paris" })) {
      arrondissements = parisArrondissements;
    }
    return arrondissements.map(function(data) {
      return {
        code: data.code,
        nom: data.nom,
        departement: { code: data.d_code, nom: data.d_nom }
      };
    }).concat(results);
  }

  $("#id_commune").autocomplete({
    deferRequestBy: 100,
    minChars: 1,
    onSelect: function(suggestion) {
      $(this).val(suggestion.value);
      $("#id_code_insee").val(suggestion.data.code);
    },
    lookup: function (query, done) {
      const req = $.ajax({
        url: "https://geo.api.gouv.fr/communes",
        data: {
          nom: query,
          fields: "departement",
          boost: "population",
          limit: 5
        }
      })
        .then(function(results) {
          done({
            suggestions: addArrondissements(results).map(function(result) {
              return {
                value: result.nom + " (" + result.departement.code + ", " + result.departement.nom + ")",
                data: {
                  code: result.code
                }
              };
            })
          });
        })
        .fail(function (err) {
          console.error(err);
        });
    }
  });
  </script>
  <datalist id="public_erp_types">
    {% for type, label in public_erp_types.items %}
    <option value="{{ type }}">{{ label }}</option>
    {% endfor %}
  </datalist>
</form>
