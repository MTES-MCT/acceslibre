{% load static %}

<form class="a4a-search-form" id="search-form" action="{% url "search" %}">
  <input type="hidden" name="lat">
  <input type="hidden" name="lon">
  <div id="loc-field" class="form-group custom-control custom-switch mb-1 mt-0">
    <input type="checkbox" class="custom-control-input" name="localize" id="localize" value="1"
      {% if localize == "1" %}checked{% endif %}>
    <label class="custom-control-label{% if dark %} text-light{% endif %}" for="localize">
      Rechercher autour de ma position géographique actuelle
      <span id="geoloader" class="lds-dual-ring" style="vertical-align:middle"></span>
      <strong id="loc" aria-live="polite" title="Mon emplacement"></strong>
    </label>
  </div>
  <div class="row">
    <div class="where-field col-xl-6 py-1">
      <input type="hidden" id="search_where_label" name="search_where_label" value="{{ search_where_label }}">
      <label for="search_where">
        <strong class="larger-font{% if dark %} text-light{% endif %}">Où</strong>
        <span class="text-{% if dark %}light{% else %}muted{% endif %}">(ville, département…)</span>
      </label>
      <select id="search_where" name="where" class="select form-control"
        aria-label="Rechercher une commune, un département"></select>
      <script>
        $(document).ready(function() {
          $search_where = $("#search_where");
          $search_where.select2({
            allowClear: true,
            placeholder: "Exemple: 69000, Clichy…",
            theme: "bootstrap4",
            width: "auto",
            ajax: {
              cache: true,
              delay: 100,
              dataType: "json",
              url: "{% url "where" %}"
            }
          });

          $search_where.on("select2:open", function(event) {
            const $results = $("#select2-search_where-results");
            if ($results.parent().find(".actions").length > 0) {
              return;
            }
            const menu = `
              <div class="actions d-flex justify-content-between">
                <a class="btn btn-sm btn-link">Autour de moi</a>
                <a class="btn btn-sm btn-link">France entière</a>
              </div>
            `;
            $(menu).insertBefore($results);
          });

          $search_where.on("select2:select", function(event) {
            try {
              $("#search_where_label").val(event.params.data.text);
            } catch(err) {
              console.warn("Unable to retrieve where data", err);
            }
          });

          // Initialisation et vérification de la présence d'une valeur pré-sélectionnée
          const search_where_label = $("#search_where_label").val();
          const search_where_value = "{{ search_where }}";
          if (search_where_label && search_where_value) {
            let option = new Option(search_where_label, search_where_value, false, false);
            $search_where.append(option).trigger("change");
          }
        });
      </script>
    </div>
    <div class="what-field col-xl-6 py-1">
      <label for="search_what">
        <strong class="larger-font{% if dark %} text-light{% endif %}">Quoi</strong>
        <span class="text-{% if dark %}light{% else %}muted{% endif %}">(activité, nom de l'établissement…)</span>
      </label>
      <div class="input-group">
        <input type="search" id="search_what" name="what"
          class="form-control" placeholder="Exemple: mairie, café de l'église…"
          aria-label="Rechercher un établissement, une activité" autocomplete="off"
          value="{{ search_what|default_if_none:"" }}">
        <div class="input-group-append">
          <button type="submit" class="btn {% if dark %}btn-light{% else %}btn-primary{% endif %} border-left text-nowrap">
            <i aria-hidden="true" class="icon icon-magnifying-glass a4a-icon-small-top"></i>
            <span class="sr-only">Rechercher</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  {% if from_home %}
  <p class="text-center pt-3 mb-0">
    Ou accedez à <a href="{% url "communes" %}">la liste des territoires pilotes</a>.
  </p>
  {% endif %}
</form>
